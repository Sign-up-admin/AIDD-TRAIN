# 训练停止功能测试指南

本文档提供了训练停止功能的完整测试指南，包括前端和后端的测试步骤。

## 测试前准备

1. **确保服务已启动**
   ```bash
   # 启动所有服务
   python start_all_services.bat
   
   # 或分别启动
   # Registry服务 (端口8500)
   python services/registry/server.py --host 0.0.0.0 --port 8500
   
   # COMPASS服务 (端口8080)
   python compass/service_main.py --host 0.0.0.0 --port 8080 --registry-url http://localhost:8500
   
   # FlashDock前端 (端口8501)
   cd FLASH_DOCK-main
   streamlit run FlashDock.py --server.port 8501
   ```

2. **验证服务状态**
   - Registry: http://localhost:8500/health
   - COMPASS: http://localhost:8080/health
   - FlashDock: http://localhost:8501

## 测试场景

### 场景1: API直接测试（后端测试）

使用提供的测试脚本进行API级别的测试：

```bash
# 运行API测试脚本
python test_training_stop_api_only.py

# 或使用调试工具
python debug_training_stop.py
```

**预期结果**:
- ✅ 测试脚本能够成功创建任务
- ✅ 任务能够成功启动
- ✅ 停止请求能够成功发送
- ✅ 任务状态在合理时间内（通常<5秒）更新为 `cancelled`
- ✅ 所有测试场景通过

### 场景2: 前端停止按钮测试（前端后端联调）

#### 步骤1: 创建训练任务

1. 打开浏览器访问 http://localhost:8501
2. 导航到"训练管理"页面
3. 点击"创建训练任务"
4. 填写训练配置：
   - 执行模式: `smoke_test` (快速测试)
   - 训练轮数: `5`
   - 批次大小: `2`
   - 学习率: `0.001`
   - 优化器: `adam`
5. 点击"创建任务"
6. 记录任务ID

**预期结果**:
- ✅ 任务创建成功
- ✅ 显示任务ID和状态（应该是 `pending`）

#### 步骤2: 启动训练任务

1. 在任务列表中找到刚创建的任务
2. 点击"启动任务"按钮
3. 等待任务状态变为 `running` 或 `initializing`

**预期结果**:
- ✅ 任务成功启动
- ✅ 状态更新为 `running` 或 `initializing`
- ✅ 可以看到训练日志输出

#### 步骤3: 停止训练任务（关键测试）

**测试点1: 快速操作停止**

1. 在任务列表中，找到运行中的任务
2. 点击"停止任务"按钮
3. 观察以下内容：

**预期结果**:
- ✅ 显示"正在停止任务..."的加载提示
- ✅ 显示"✓ 任务停止请求已发送"的成功消息
- ✅ 在5秒内，任务状态更新为 `cancelled`
- ✅ 显示"✓ 任务状态已更新为: 已取消"
- ✅ 页面自动刷新，显示最新状态

**测试点2: 详情页面停止**

1. 点击任务的"查看详情"按钮
2. 在详情页面点击"停止任务"按钮
3. 观察停止流程

**预期结果**:
- ✅ 与快速操作停止相同的预期结果

**测试点3: 错误处理测试**

1. 尝试停止一个已完成的任务
2. 尝试停止一个不存在的任务（如果可能）

**预期结果**:
- ✅ 显示适当的错误消息
- ✅ 错误消息包含有用的提示信息
- ✅ 不会导致页面崩溃

### 场景3: 边界情况测试

#### 测试1: 快速停止（任务刚启动就停止）

1. 创建并启动任务
2. 立即（在1秒内）点击停止按钮

**预期结果**:
- ✅ 停止请求成功发送
- ✅ 任务在下一个检查点停止
- ✅ 状态正确更新

#### 测试2: 停止过程中的状态检查

1. 启动一个训练任务
2. 点击停止按钮
3. 在停止过程中，快速刷新页面
4. 检查状态是否正确更新

**预期结果**:
- ✅ 状态正确同步
- ✅ 不会出现状态不一致的情况

#### 测试3: 网络超时处理

1. 启动训练任务
2. 模拟网络延迟（如果可能）
3. 点击停止按钮

**预期结果**:
- ✅ 超时错误被正确处理
- ✅ 显示适当的超时提示
- ✅ 如果任务实际已停止，能够检测到并更新状态

## 调试工具使用

### 使用 debug_training_stop.py

```bash
python debug_training_stop.py
```

该工具提供：
- 交互式任务选择
- 实时状态监控
- 详细的日志输出
- 响应时间测量

### 查看后端日志

后端日志包含详细的停止流程信息：

```bash
# 查看COMPASS服务日志
tail -f logs/compass_service.log

# 查找停止相关的日志
grep "[STOP]" logs/compass_service.log
```

关键日志标记：
- `[STOP] Stop request received` - 停止请求接收
- `[STOP] Cancellation flag set` - 取消标志设置
- `[STOP] Task responded quickly` - 任务快速响应
- `[CANCELLATION]` - 训练循环中的取消检测

## 验证检查清单

### 后端验证

- [ ] `stop_task` API返回200状态码
- [ ] 取消标志正确设置到 `progress_tracker`
- [ ] 训练循环在下一个检查点检测到取消标志
- [ ] 任务状态正确更新为 `cancelled`
- [ ] WebSocket流收到停止消息
- [ ] 日志包含详细的调试信息

### 前端验证

- [ ] 停止按钮正确显示（仅在running/initializing状态）
- [ ] 点击停止按钮后显示加载提示
- [ ] 成功消息正确显示
- [ ] 状态轮询正确工作
- [ ] 错误情况被正确处理
- [ ] 页面刷新后状态正确显示

### 端到端验证

- [ ] 从创建到停止的完整流程正常工作
- [ ] 停止响应时间合理（<5秒）
- [ ] 没有资源泄漏
- [ ] 多次停止/启动操作稳定

## 常见问题排查

### 问题1: 停止请求发送但任务未停止

**可能原因**:
- 训练循环没有检查取消标志
- 取消标志没有正确传递

**排查步骤**:
1. 检查后端日志中的 `[STOP]` 标记
2. 确认取消标志已设置：`cancelled: true`
3. 检查训练循环日志中的 `[CANCELLATION]` 标记

### 问题2: 前端显示超时但任务实际已停止

**可能原因**:
- 网络延迟导致超时
- 状态轮询间隔太长

**解决方案**:
- 前端已实现超时后的状态检查
- 如果检测到任务已停止，会自动更新状态

### 问题3: 停止后任务状态不一致

**可能原因**:
- 竞态条件
- 状态更新延迟

**排查步骤**:
1. 检查后端日志中的状态更新时间戳
2. 使用调试工具监控状态变化
3. 刷新前端页面查看最新状态

## 性能指标

### 预期性能

- **停止请求响应时间**: < 2秒（API返回）
- **任务实际停止时间**: < 5秒（从请求到状态更新）
- **状态轮询间隔**: 0.5秒
- **最大轮询时间**: 5秒

### 监控指标

- API响应时间
- 状态更新延迟
- 取消标志设置时间
- 训练循环检查频率

## 测试报告模板

```
测试日期: [日期]
测试人员: [姓名]
测试环境: [环境描述]

测试结果:
- 场景1 (API测试): [PASS/FAIL]
- 场景2 (前端测试): [PASS/FAIL]
- 场景3 (边界测试): [PASS/FAIL]

发现的问题:
1. [问题描述]
2. [问题描述]

性能指标:
- 平均停止响应时间: [时间]
- 成功率: [百分比]
```

## 后续改进建议

1. **添加自动化测试**
   - 集成到CI/CD流程
   - 定期运行端到端测试

2. **增强监控**
   - 添加性能指标收集
   - 实时监控停止成功率

3. **用户体验优化**
   - 添加停止进度指示
   - 优化错误消息显示

4. **文档完善**
   - 添加用户使用指南
   - 更新API文档








