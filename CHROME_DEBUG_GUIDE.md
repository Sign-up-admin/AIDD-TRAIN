# Chrome浏览器前后端联调调试指南

## 服务启动状态

所有服务已启动：
- ✅ 服务注册中心: http://localhost:8500
- ✅ COMPASS服务: http://localhost:8080
- ✅ FLASH-DOCK前端: http://localhost:8501

## 快速开始

### 方法1：使用自动化脚本（推荐）

运行自动化脚本，它会自动创建任务、启动任务，然后等待你在Chrome中点击停止按钮：

```bash
python chrome_debug_auto.py
```

脚本会：
1. 自动创建训练任务
2. 自动启动任务
3. 等待任务进入running状态
4. 提示你在Chrome中进行操作
5. 监控任务状态变化

### 方法2：手动操作

1. 打开Chrome浏览器，访问 http://localhost:8501
2. 按F12打开开发者工具
3. 创建训练任务并启动
4. 点击停止按钮
5. 观察Network和Console标签页

## Chrome开发者工具设置

### 1. 打开开发者工具
- 按 `F12` 或右键页面选择"检查"
- 确保开发者工具窗口可见

### 2. Network标签页设置
- 切换到 **Network** 标签页
- **重要**：勾选 **"Preserve log"**（保留日志），这样页面刷新后请求记录不会丢失
- 清空之前的请求记录（点击清除按钮）
- 在过滤框中输入 `/api/v1/training/tasks` 来过滤相关请求

### 3. Console标签页设置
- 切换到 **Console** 标签页
- 确保显示所有级别的日志（Verbose、Info、Warnings、Errors）
- 清空之前的日志（点击清除按钮）

## 调试步骤详解

### 步骤1：创建训练任务

1. 在浏览器中打开训练管理页面
2. 点击"创建训练任务"标签页
3. 配置参数：
   - 执行模式：smoke_test
   - 训练轮数：10（确保有足够时间测试停止）
   - 批次大小：2
   - 学习率：0.001
   - 优化器：adam
4. 点击"创建训练任务"按钮

**在Network标签页中观察**：
- 查找 POST 请求到 `/api/v1/training/tasks`
- 检查响应状态码（应该是201）
- 检查响应内容，记录返回的 `task_id`

### 步骤2：启动训练任务

1. 在任务列表中找到刚创建的任务
2. 点击"启动任务"按钮

**在Network标签页中观察**：
- 查找 POST 请求到 `/api/v1/training/tasks/{task_id}/start`
- 检查响应状态码（应该是200）
- 检查响应时间

**在Console标签页中观察**：
- 是否有JavaScript错误
- 是否有WebSocket连接相关的日志

3. 等待任务状态变为"running"或"initializing"

### 步骤3：尝试停止训练（关键步骤）

**准备工作**：
1. 在Network标签页中：
   - 确保已勾选"Preserve log"
   - 清空之前的请求记录
   - 准备监控停止请求

2. 在Console标签页中：
   - 清空之前的日志
   - 准备观察错误信息

**执行停止操作**：
1. 点击"停止任务"按钮

**立即观察Network标签页**：
查找 POST 请求到 `/api/v1/training/tasks/{task_id}/stop`

**关键检查点**：
- ✅ **请求是否发送成功？**
  - 如果请求未出现，说明前端JavaScript可能出错
  - 检查Console标签页是否有错误

- ✅ **请求状态码是什么？**
  - `200`: 请求成功，后端已处理
  - `400`: 请求失败，可能是任务状态错误
  - `404`: 任务不存在
  - `500`: 服务器内部错误
  - `pending`/`超时`: 请求未完成，可能后端阻塞

- ✅ **响应时间是多少？**
  - 如果超过10秒，说明后端可能阻塞
  - 正常应该在2秒内返回（根据代码，后端有2秒快速检查）

- ✅ **响应内容是什么？**
  - 成功响应应该包含 `{"message": "...", "task_id": "..."}`
  - 错误响应应该包含详细的错误信息

- ✅ **请求详情**：
  - 点击请求，查看 **Headers** 标签页
  - 查看 **Payload** 标签页（如果有）
  - 查看 **Response** 标签页
  - 查看 **Timing** 标签页（了解请求各阶段耗时）

**观察Console标签页**：
- ✅ 是否有JavaScript错误？
  - 红色错误信息
  - 错误堆栈信息
- ✅ 是否有网络错误？
  - CORS错误
  - 连接超时错误
  - 其他网络相关错误
- ✅ 是否有WebSocket错误？
  - WebSocket连接失败
  - WebSocket消息错误

**观察页面显示**：
- ✅ 是否显示"正在停止任务..."加载状态？
  - 应该显示spinner或loading提示
- ✅ 是否显示成功消息或错误消息？
  - 成功：应该显示"✓ 任务停止请求已发送"
  - 失败：应该显示错误信息
- ✅ 错误消息是否可见？
  - 错误消息应该在页面上直接显示
  - 不应该隐藏在collapsed的expander中
- ✅ 任务状态是否更新？
  - 检查任务状态是否从"running"变为"cancelled"
  - 如果状态未更新，说明后端可能未正确处理停止请求

### 步骤4：检查后端日志

**COMPASS服务窗口**：
1. 查看是否有停止请求的日志
2. 查找 `[STOP]` 标记的日志
3. 检查日志中的关键信息：
   - 停止请求接收时间
   - 任务当前状态
   - 取消标志设置情况
   - 任务状态变化
   - 错误或异常信息

**日志文件**（如果存在）：
- `logs/compass-service.log`
- `logs/task_{task_id}/` 目录下的日志文件

## 问题诊断

### 情况A：请求未发送

**现象**：
- Network标签页中没有停止请求
- 点击按钮后没有任何网络活动

**可能原因**：
1. 前端JavaScript错误阻止了请求
2. 按钮点击事件未正确绑定
3. 任务状态检查失败，按钮未显示或禁用

**检查方法**：
1. 查看Console标签页是否有JavaScript错误
2. 检查按钮是否可见和可点击
3. 检查任务状态是否正确

### 情况B：请求超时

**现象**：
- 请求显示为pending状态
- 然后超时（通常超过10秒）
- 前端显示超时错误

**可能原因**：
1. 后端`stop_task`方法阻塞时间过长（超过10秒超时）
2. 网络连接问题
3. 后端服务无响应

**检查方法**：
1. 查看后端服务窗口是否有响应
2. 检查后端日志是否有处理停止请求的记录
3. 检查网络连接

### 情况C：请求返回400错误

**现象**：
- 请求返回400状态码
- 响应中包含错误信息

**可能原因**：
1. 任务状态已改变（不再是running/initializing）
2. 后端状态检查失败
3. 错误信息可能不够详细

**检查方法**：
1. 查看响应内容中的详细错误信息
2. 检查任务当前状态
3. 检查后端日志中的状态检查逻辑

### 情况D：请求返回200但任务未停止

**现象**：
- 请求成功返回200
- 但任务状态未更新为cancelled
- 任务仍在运行

**可能原因**：
1. 后端设置了取消标志，但训练循环未响应
2. 训练循环中的取消检查点未执行
3. 任务线程未正确检查取消标志

**检查方法**：
1. 查看后端日志，确认取消标志是否设置
2. 检查训练循环中是否有取消检查点
3. 检查任务线程是否仍在运行

### 情况E：前端显示错误但不可见

**现象**：
- 后端返回错误
- 但前端页面没有显示错误信息
- 或错误信息在collapsed的expander中

**可能原因**：
1. Streamlit的expander默认collapsed
2. `st.rerun()`导致错误信息丢失
3. 错误处理代码有问题

**检查方法**：
1. 查看页面源代码或元素
2. 检查是否有隐藏的错误信息
3. 检查前端错误处理代码

## 记录调试信息

在调试过程中，请记录以下信息：

### 1. 网络请求详情
- 请求URL：`POST /api/v1/training/tasks/{task_id}/stop`
- 请求方法：POST
- 请求状态码：200/400/404/500/超时
- 请求时间：发送时间
- 响应时间：从发送到接收的时间（毫秒）
- 响应内容：完整的响应JSON

### 2. 控制台错误
- JavaScript错误：错误消息和堆栈
- 网络错误：错误类型和消息
- WebSocket错误：连接状态和错误信息

### 3. 后端日志
- 停止请求接收时间
- 任务当前状态
- 取消标志设置情况
- 任务状态变化时间线
- 任何错误或异常

### 4. 页面行为
- 按钮点击后的页面变化
- 加载状态的显示
- 成功/错误消息的显示
- 任务状态的更新情况
- 页面刷新情况

## 下一步行动

根据调试结果：

1. **如果发现具体问题**：
   - 记录问题现象和原因
   - 提出针对性的修复方案
   - 实施修复并验证

2. **如果问题已解决**：
   - 记录解决方案
   - 更新文档
   - 进行回归测试

## 辅助工具

### 自动化脚本
- `chrome_debug_auto.py`: 自动创建任务、启动任务、监控状态
- `chrome_debug_helper.py`: 交互式调试辅助工具

### 测试脚本
- `test_training_stop_chrome.py`: Playwright自动化测试脚本

## 相关文档

- `CHROME_STOP_TRAINING_ISSUE_REPORT.md`: 问题诊断报告
- `CHROME_TEST_GUIDE.md`: Chrome测试指南
- `TRAINING_STOP_DIAGNOSIS_SUMMARY.md`: 训练停止问题诊断总结








